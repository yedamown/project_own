<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">

<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>ì±„íŒ…ë°©</title>
<!-- CSS -->
<link rel="stylesheet" href="/css/chat/css/chatroom.css">
</head>

<body>
	<div class="chat-box">
		<div class="header"> 
			<div class="avatar-wrapper avatar-big">
				<img th:src=|/imgView/${chatInfo[0].profileImg}| alt="avatar" />
			</div>
			<span class="name" th:text="${chatInfo[0].chatroomName}"></span> 
		</div>
		<!-- =========================== ëŒ€í™”ë°© =========================== -->
		<div class="chat-room" ></div>
		<!-- =========================== ëŒ€í™”ì…ë ¥ =========================== -->
		<div class="type-area">
			<div class="input-wrapper">
				<input type="text" id="inputText" placeholder="ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeypress="sendMessage()"/>
			</div>

			<span class="button-add"> <i class="fas fa-plus-circle"></i>
				<div class="others">
					<span class="emoji-button"> <i class="far fa-laugh"></i>
						<div class="emoji-box">
							<span>&#x1f604;</span> 
							<span>ğŸ˜€</span> <span>ğŸ˜‚</span> <span>ğŸ˜</span> <span>ğŸ˜­</span> <span>ğŸ¤®</span> <span>ğŸ¤‘</span>
							<span>ğŸ˜–</span> <span>ğŸ˜·</span> <span>ğŸ˜</span> <span>ğŸ˜‹</span> <span>ğŸ˜¥</span> <span>ğŸ™„</span>
							<span>ğŸ˜</span> <span>ğŸ¤</span> <span>ğŸ¥±</span> <span>ğŸ˜´</span> <span>ğŸ¤¯</span> <span>ğŸ¤¢</span>
							<span>ğŸ¤®</span> <span>ğŸ˜·</span> <span>ğŸ¤¬</span> <span>ğŸ’•</span> <span>ğŸ’</span> 
						</div>
					</span>
				</div>
			</span>
			<button class="button-send">Send</button>
		</div>

	</div>
	<!-- ì œì´ì¿¼ë¦¬ -->
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<!-- ì›¹ì†Œì¼“ cdn -->
	<script src="/webjars/sockjs-client/sockjs.min.js"></script>
	<script src="/webjars/stomp-websocket/stomp.min.js"></script>
	<!-- í°íŠ¸ì–´ì¸ cdn -->
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
	<script th:inline="javascript">
			/*<![CDATA[*/
			var header = /*[[${_csrf.headerName}]]*/'defalut';
			var token = /*[[${_csrf.token}]]*/'defalut';
			console.log(header);
			console.log(token);
			/*]]>*/
		//Content Loaded
		window.addEventListener("DOMContentLoaded", (e) => {
			var header = document.querySelector(".header");
			var chatRoom = document.querySelector(".chat-room");
			var typeArea = document.querySelector(".type-area");
			var btnAdd = document.querySelector(".button-add");
			var others = document.querySelector(".others");
			var emojiBox = document.querySelector(".emoji-button .emoji-box");
			var emojiButton = document.querySelector(".others .emoji-button");
			var emojis = document.querySelectorAll(".emoji-box span");
			var inputText = document.querySelector("#inputText");
			var btnSend = document.querySelector(".button-send");
			
			// ìŠ¤í¬ë¡¤ í•­ìƒ ì•„ë˜ë¡œ
			var $chatroom = $('.chat-room');
			$chatroom.scrollTop($chatroom[0].scrollHeight);	
			
			
			//Header onclick event
			header.addEventListener("click", (e) => {
				if (typeArea.classList.contains("d-none")) {
					header.style.borderRadius = "20px 20px 0 0";
				} else {
					header.style.borderRadius = "20px";
				}
				typeArea.classList.toggle("d-none");
				chatRoom.classList.toggle("d-none");
			});
			//Button Add onclick event
			btnAdd.addEventListener("click", (e) => {
				if(others.classList.contains("others-show") ){
					others.classList.remove("others-show")
				}else{
					others.classList.add("others-show")
				};
			});
			//Emoji onclick event
			emojiButton.addEventListener("click", (e) => {
				emojiBox.classList.add("emoji-show");
				others.classList.toggle("others-show");
				
			});
			
			for (var emoji of emojis) {
				emoji.addEventListener("click", (e) => {
					e.stopPropagation();
					emojiBox.classList.remove("emoji-show");
					others.classList.remove("others-show");
					inputText.value += e.target.textContent;
				});
			}
		});
			// urlì—ì„œ ì±„íŒ…ë°© ë²ˆí˜¸, ë©”ì„¸ì§€ë³´ë‚´ëŠ” ìœ ì €ì˜ ë°´ë“œë©¤ë²„ì‹ë³„ë²ˆí˜¸ ì½ì–´ì˜¤ê¸°
			const link = window.location.href;
			var url = new URL(link);
			const urlParams = url.searchParams;
			let chatroomNo = urlParams.getAll('chatroomNo');
			let userNo = urlParams.getAll('bandMemberNo');
			console.log(chatroomNo[0])
			console.log(userNo[0])
			// ì›¹ì†Œì¼“ êµ¬ë…í•˜ê¸°
			var stompClient = null;

			$(function() {
				connect();
				getMessage();
			});
			
			function connect() {
				var socket = new SockJS('/chat');
				stompClient = Stomp.over(socket);
				stompClient.connect({}, function (frame) {
					console.log('Connected: ' + frame);
					//ë°© êµ¬ë…í•˜ê¸°
					stompClient.subscribe('/subscribe/chat/room/' + chatroomNo[0], function (chat) { 
					var chatRoom = document.querySelector(".chat-room"); 
					var content = JSON.parse(chat.body);
					var writerNo = content.bandMemberNo;
                    var writerNickname = content.bandNickname;
                    var mContent = content.messageContent;
                    var time = content.messageTime;
                 	
					 	if(writerNo === userNo[0]){
					 		var messageDivR = document.createElement('div');
					 		messageDivR.className += "message message-right"
					 		var mess = mContent;
					 		var bubbleD = document.createElement('div');
							bubbleD.className += "bubble bubble-dark";
							bubbleD.textContent = mess;
							chatRoom.appendChild(messageDivR);
							messageDivR.appendChild(bubbleD);
						
							
							var $chatroom = $('.chat-room');
							$chatroom.scrollTop($chatroom[0].scrollHeight);
                        }
                        else{
                        	var messageDivL = document.createElement('div');
                        	messageDivL.className += "message message-left"
                        	var mess = mContent;
                        	var bubbleL = document.createElement('div');
							bubbleL.className += "bubble bubble-light";
							bubbleL.textContent = mess;
							chatRoom.appendChild(messageDivL);
							messageDivL.appendChild(bubbleL);
							
							
							var $chatroom = $('.chat-room');
							$chatroom.scrollTop($chatroom[0].scrollHeight);
                        }							

					});
                    
					// ì…ì¥ë©”ì„¸ì§€ ë³´ë‚´ê¸°
					stompClient.send('/publish/chat/room/enter', {}, JSON.stringify({ 
						chatroomNo: chatroomNo[0], 
						bandMemberNo: userNo[0] }))
					});
			}
			
			// ë©”ì„¸ì§€ ë³´ë‚´ê¸°
			$('.button-send').click(function sendMessage() {
				stompClient.send("/publish/chat/room", {}, JSON.stringify({
					chatroomNo : chatroomNo[0],
					bandMemberNo: userNo[0],
					messageContent: document.querySelector("#inputText").value
				}));
				
				inputText.value = "";
			})
			function sendMessage(){
				stompClient.send("/publish/chat/room", {}, JSON.stringify({
					chatroomNo : chatroomNo[0],
					bandMemberNo: userNo[0],
					messageContent: document.querySelector("#inputText").value
				}));
				
				inputText.value = "";
			}

			// ì±„íŒ…ë°©ì˜ ê¸°ì¡´ ë©”ì„¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
			function getMessage() {
				$.ajax({
					url : '/getMessage?chatroomNo='+ chatroomNo[0],
					method : 'get',
					dataType : 'json',
					contentType : "application/json"
				}).then(chat => {
					$.each(chat, function(i, e){
						var chatRoom = document.querySelector(".chat-room"); 
						var writerNo = $(this).attr("bandMemberNo");
	                    var mContent = $(this).attr("messageContent");
	                    chatRoom.ScrollTop = chatRoom.scrollHeight;
	                    if(writerNo === userNo[0]){
					 		var messageDivR = document.createElement('div');
					 		messageDivR.className += "message message-right"
					 		var mess = mContent;
					 		var bubbleD = document.createElement('div');
							bubbleD.className += "bubble bubble-dark";
							bubbleD.textContent = mess;
							chatRoom.appendChild(messageDivR);
							messageDivR.appendChild(bubbleD);
							
							
							var $chatroom = $('.chat-room');
							$chatroom.scrollTop($chatroom[0].scrollHeight);
                        }
                        else{
                        	var messageDivL = document.createElement('div');
                        	messageDivL.className += "message message-left"
							
                        		var mess = mContent;
                        	var bubbleL = document.createElement('div');
							bubbleL.className += "bubble bubble-light";
							bubbleL.textContent = mess;
							chatRoom.appendChild(messageDivL);
							messageDivL.appendChild(bubbleL);
						
							var $chatroom = $('.chat-room');
							$chatroom.scrollTop($chatroom[0].scrollHeight);	
                        }						 
					})
                 	
					 	
				})
			}
			
			// ì›¹ì†Œì¼“ ì—°ê²°ëŠê¸°
			function disconnect() {
				if (stompClient !== null) {
					stompClient.disconnect();
				}
				setConnected(false);
				console.log("Disconnected");
			}
		

	</script>
</body>

</html>