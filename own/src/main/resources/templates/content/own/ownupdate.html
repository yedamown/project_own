<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

</head>
<div layout:fragment="content">
 <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <style>
    body {
      min-height: 100vh;
    }

    .input-form {
      max-width: 680px;

      margin-top: 80px;
      padding: 32px;

      background: #fff;
      -webkit-border-radius: 10px;
      -moz-border-radius: 10px;
      border-radius: 10px;
      -webkit-box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.15);
      -moz-box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.15);
      box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.15)
    }
    .checkDone, .notYet, .finepw, .notpw .checkid{
			display:none;
		}
  </style>
<body>
        <h1>내정보 수정</h1>
        
       <div id = "container">
        <div class="input-form-backgroud row">
            <div class="input-form col-md-12 mx-auto">
              <h4 class="mb-3">내정보 수정</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name">아이디</label>
                        <input type="text" class="form-control" id="u_id" th:value="${session.loginUser.userId}" disabled>
                    </div>
                </div> 
                                
                    <div class="mb-3">
                    <label for="nickname">비밀번호 변경</label>
                    <br>
                        <label for="nickname">현재 비밀번호</label>
                        <input type="text" class="form-control" id="u_pw" onchange="pwCheck()" placeholder="" value="" required>
                        <div class="invalid-feedback">
                            비밀번호를 입력해주세요.
                        </div>
                    </div>      
                    <div class="mb-6">
                        <label for="nickname">변경할 비밀번호 (8~16자 특수문자,영문,숫자 하나이상입력)</label>
                        <input type="text" class="form-control" id="u_newpw" oninput="pwMatchCheck()" placeholder="" value="" required>
                        <div class="invalid-feedback">
                            비밀번호를 입력해주세요.
                        </div>
                         <label for="nickname">변경할 비밀번호 확인</label>
                        <input type="text" class="form-control" id="u_newpw2" oninput="pwMatchCheck()" placeholder="" value="" required>
                        <div class="invalid-feedback">
                            비밀번호를 입력해주세요.
                        </div>
                        <br>
                         <span class="notpw" >비밀번호가 일치하지 않습니다</span>
				                 <span class="finepw">비밀번호가 일치합니다</span>                   
                    </div>
                         			
                <div class="mb-3">
                    <label for="email">이름</label>
                    <input type="email" class="form-control" id="u_name"  th:value="${session.loginUser.userName}" disabled>
                    <div class="invalid-feedback">
                      이름을 입력해주세요.
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">                      
                      <label for="email">이메일</label>
                      <input type="email" class="form-control" id="u_email"  th:value="${session.loginUser.userEmail}" disabled>
                    </div>
                  </div>
      			
                <div class="mb-3">
                  <label for="address">전화번호</label>
                  <input type="text" class="form-control" id="u_tel"  th:value="${session.loginUser.userPhone}">
                  <div class="invalid-feedback">
                    전화번호를 입력해주세요.
                  </div>
                </div>
                
                <div class="column">
                    <div class="col-md-4 mb-3">
                    <label for="code">관심운동</label>
                    <select id="exersub2">
                        <option value="none"></option>
                    </select>
                    <div class="invalid-feedback">
                      관심운동을 선택해주세요.
                    </div>
                  </div>
                </div>
                <hr class="mb-4">
                <button type="button" id="btnupdate">가입 완료</button>              
            </div>
        </div>
        </div>
<script th:inline="javascript">
  /*<![CDATA[*/
  var header = /*[[${_csrf.headerName}]]*/'defalut';
  var token = /*[[${_csrf.token}]]*/'defalut';
    console.log(header);
    console.log(token);

  /*]]>*/

    function pwCheck() {
    	var regExpPw = /(?=.*\d{1,20})(?=.*[~`!@#$%\^&*()-+=]{1,20})(?=.*[a-zA-Z]{1,20}).{8,20}$/;
    	let pw = $('#u_pw').val();
    	if (!regExpPw.test(pw)) {
    		$('.notpw').show();
    		$('.finepw').hide();
    		$('#u_pw').focus();
    	} else {
    		$('.finepw').show();
    		$('.notpw').hide();
    	}
    }
    
    function pwMatchCheck() {
    	let pw = $('#u_pw').val();
    	let cpw = $('#u_pw2').val();
    	if (pw == cpw) {
    		$('.checkDone').show();
    		$('.notYet').hide();
    	} else {
    		$('.notYet').show();
    		$('.checkDone').hide();
    	}
    }
    
    
    //아이디중복체크
        $('#idchk').on('click',function(){
        	let id = $('#u_id').val();  
          console.log(id)
        	var specialRule = /[`~!@#$%^&*|\\\'\";:\/?]/gi;
        	var korean = /[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/;
        	var capital = /[A-Z]/;
        	if(id.length>12 || id.length<4){
        		alert("글자수를 맞춰주세요");
        		$('#u_id').val("");
        		$('#u_id').focus();
        		return
        	}
        	if(specialRule.test(id)) {
                alert("특수문자는 입력 불가합니다");
        		$('#u_id').focus();
        		return
        	}else if(korean.test(id)){
        		alert("한글은 입력불가합니다");
        		$('#u_id').focus();
        		return
        	}else if(capital.test(id)){
        		alert("소문자로만 입력해주세요");
        		$('#u_id').focus();
        		return
        	}        	
        
          $.ajax({
            url: '/own/idcheck',
            method: 'post',
            data : {id},
            beforeSend: function(xhr){
              xhr.setRequestHeader(header,token);
            }
          }).then(res=>{
              if(res==1){    	  
            	  $("#u_id").attr('value',0)
            	  $("#idchk").attr('value',0)
              }
              else{
				  $("#idchk").attr('value',1)
            	  $("#u_id").attr('value',1)
                console.log('가능한아이디')
              }
          })
        })
        
        $.ajax({
			url : '/common/exersub',
			method : 'get',
			//dataType : 'object' ,//응답결과랑 타입이 같아야함
			contentType : "application/json" //json으로 보낼때 타입이 이렇다..
		}).then(res=>{
			for(sub of res){
				$("#exersub").append(makeSub(sub));
                
				$("#exersub2").append(makeSub(sub));
			}
		})
        
		
		function makeSub(sub){
        let tag = `<option value="${sub.exersubNo}">${sub.exersubNo}${sub.exersubName}</option>`

		return tag;
		}
		

    $('#emailchk').on('click',function(){
      console.log("ㅇㅇ");
    })
        	
    		$('#btnupdate').on("click",function(){
    			let id = $('#u_id').val();
    			let pw = $('#u_pw').val();
    			let newpw = $('#u_newpw').val();
    			let newpw2 = $('#u_newpw2').val();
    			let phone = $('#u_tel').val();
    			let hobby = $('#exersub2').val();
          console.log(id);
          console.log(pw);
          console.log(newpw);
          console.log(newpw2);
          console.log(phone);
          console.log(hobby);
            $.ajax({
    				url : '/own/pwcheck',
    				method : 'get',
    				// json형태면 JSON.stringify ((무조건)) 넣기..
    				data :  {id, pw, newpw}
    			}).then(res=>{
            if(res=='1'){
              if(newpw==newpw2){
              console.log('변경완료')
              }
              else{
                console.log('변경할 비밀번호가 서로 맞지않습니다')
              }
            }else{
              alert('현재 비밀번호가 맞지않습니다')
              console.log('현재비번 틀림')
            }
            
    			})
    		})
        // JSON.stringify({userId:id,
    		// 							   userPasswd:pw,
    		// 							   userName:name,
    		// 							   userEmail:email,
    		// 							   userPhone:tel,
    		// 							   userBirthday:birthday,
    		// 							   userGender:gender})
        
        </script>
</body>
</div>
</html>